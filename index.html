<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Go Japan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', 'Noto Sans JP', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .jp-font { font-family: 'Noto Sans JP', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .loader {
            border: 3px solid #e2e8f0;
            border-radius: 50%;
            border-top: 3px solid #4f46e5;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen flex flex-col overflow-hidden">

    <div id="app" class="max-w-md mx-auto w-full h-full bg-white shadow-2xl relative flex flex-col">
        
        <header class="bg-indigo-600 text-white p-4 shadow-md z-20 flex-none flex justify-between items-center">
            <h1 class="text-lg font-bold flex items-center gap-2">
                <span>ğŸ‡¯ğŸ‡µ</span> {{ pageTitle }}
            </h1>
            <span class="text-[10px] font-bold bg-indigo-500 px-2 py-1 rounded text-indigo-50 tracking-wider">
               {{ currentTab === 'vocab' ? currentLevel.toUpperCase() : 'APP' }}
            </span>
        </header>

        <main class="flex-1 overflow-y-auto overflow-x-hidden bg-slate-50 relative scroll-smooth pb-24" ref="mainScroll">
            
            <div v-show="currentTab === 'talk'" class="p-4 space-y-4">
                <div class="flex overflow-x-auto gap-2 pb-2 no-scrollbar">
                    <button v-for="cat in conversationCats" :key="cat.id" 
                        @click="currConvCat = cat.id"
                        :class="['px-4 py-2 rounded-full whitespace-nowrap text-sm font-bold transition-all border', 
                        currConvCat === cat.id ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-gray-500 border-gray-200']">
                        {{ cat.name }}
                    </button>
                </div>

                <div v-for="(item, idx) in filteredConversations" :key="idx" @click="speak(item.jp)"
                    class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 active:scale-[0.98] transition-transform flex items-center gap-3 cursor-pointer group hover:bg-indigo-50">
                    <div class="bg-indigo-100 text-indigo-600 p-3 rounded-full shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>
                    </div>
                    <div>
                        <div class="jp-font text-lg font-bold text-slate-800">{{ item.jp }}</div>
                        <div class="text-xs text-indigo-500 font-mono mb-1">{{ item.reading }}</div>
                        <div class="text-sm text-slate-500">{{ item.meaning }}</div>
                    </div>
                </div>
            </div>

            <div v-show="currentTab === 'kana'" class="p-4">
                <div class="flex bg-gray-200 rounded-lg p-1 mb-4">
                    <button @click="kanaMode = 'hira'" :class="['flex-1 py-2 text-sm font-bold rounded-md transition-all', kanaMode === 'hira' ? 'bg-white shadow text-indigo-600' : 'text-gray-500']">å¹³å‡å (ã‚)</button>
                    <button @click="kanaMode = 'kata'" :class="['flex-1 py-2 text-sm font-bold rounded-md transition-all', kanaMode === 'kata' ? 'bg-white shadow text-indigo-600' : 'text-gray-500']">ç‰‡å‡å (ã‚¢)</button>
                </div>

                <div class="grid grid-cols-5 gap-2 text-center">
                    <div v-for="(k, idx) in currentKanaList" :key="idx" 
                        @click="speak(k.char)"
                        :class="['aspect-square rounded-xl flex flex-col justify-center items-center shadow-sm border cursor-pointer active:scale-90 transition-transform select-none',
                        k.char ? 'bg-white border-slate-200 hover:border-indigo-400 hover:bg-indigo-50' : 'bg-transparent border-none shadow-none']">
                        <span class="jp-font text-xl font-bold text-slate-700">{{ k.char }}</span>
                        <span class="text-[10px] text-gray-400 font-mono uppercase mt-1">{{ k.romaji }}</span>
                    </div>
                </div>
            </div>

            <div v-show="currentTab === 'vocab'" class="flex flex-col min-h-full">
                <div class="p-4 bg-white border-b sticky top-0 z-10 shadow-sm">
                    <div class="flex justify-between gap-1 mb-3">
                        <button v-for="n in ['n5', 'n4', 'n3', 'n2', 'n1']" :key="n"
                            @click="loadVocabLevel(n)"
                            :class="['flex-1 py-2 text-xs font-bold rounded-lg uppercase tracking-wider border transition-all',
                            currentLevel === n ? 'bg-indigo-600 text-white border-indigo-600 shadow-md' : 'bg-white text-gray-500 border-gray-200']">
                            {{ n }}
                        </button>
                    </div>
                    <div class="relative">
                        <span class="absolute left-3 top-2.5 text-gray-400">ğŸ”</span>
                        <input v-model="searchQuery" placeholder="æœå°‹æ¼¢å­—ã€å‡åæˆ–æ„æ€..." 
                            class="w-full bg-slate-100 border-none rounded-lg pl-9 pr-4 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition-shadow">
                        <button v-if="searchQuery" @click="searchQuery = ''" class="absolute right-3 top-2.5 text-gray-400 text-xs bg-slate-200 rounded-full px-1.5">âœ•</button>
                    </div>
                </div>

                <div class="p-4 space-y-3 flex-1">
                    <div v-if="loading" class="flex flex-col items-center justify-center py-20 text-gray-400">
                        <div class="loader mb-3"></div>
                        <p class="text-sm">ä¸‹è¼‰ {{ currentLevel.toUpperCase() }} è³‡æ–™åº«...</p>
                        <p class="text-[10px] text-gray-300 mt-1">Source: jamsinclair/open-anki-jlpt-decks</p>
                    </div>
                    
                    <div v-else-if="error" class="text-center py-10 text-red-400 text-sm px-4">
                        <p>{{ error }}</p>
                        <button @click="loadVocabLevel(currentLevel)" class="mt-4 px-4 py-2 bg-indigo-50 text-indigo-600 rounded-full text-xs font-bold">é‡è©¦</button>
                    </div>

                    <div v-else>
                        <div class="text-right text-xs text-gray-400 mb-2">
                             å…± {{ filteredVocab.length }} å€‹å–®å­—
                        </div>
                        
                        <div v-for="(word, idx) in filteredVocab.slice(0, 50)" :key="idx" @click="speak(word.kana || word.kanji)"
                            class="bg-white border-l-4 border-emerald-500 p-3 pl-4 rounded-r-lg shadow-sm mb-3 flex justify-between items-start cursor-pointer active:bg-gray-50 hover:shadow-md transition-all">
                            <div class="flex-1">
                                <div class="flex flex-col">
                                    <span class="jp-font text-lg font-bold text-gray-800">{{ word.kanji || word.kana }}</span>
                                    <span v-if="word.kanji" class="text-xs text-indigo-600 font-mono">{{ word.kana }}</span>
                                </div>
                                <div class="text-sm text-gray-600 mt-1 leading-snug break-words pr-2">{{ word.meaning }}</div>
                            </div>
                            <span class="text-gray-300 ml-2 mt-1 shrink-0">ğŸ”Š</span>
                        </div>
                        
                        <div v-if="filteredVocab.length > 50" class="text-center py-6">
                            <span class="text-xs text-gray-400 block mb-2">é‚„æœ‰ {{ filteredVocab.length - 50 }} å€‹å–®å­—</span>
                            <button class="text-xs text-indigo-500 font-bold bg-indigo-50 px-4 py-2 rounded-full">
                                è«‹ä½¿ç”¨æœå°‹æ¡†æŸ¥æ‰¾
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <nav class="bg-white border-t border-gray-200 flex justify-around items-center p-2 pb-safe z-30 flex-none safe-bottom shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
            <button @click="switchTab('talk')" :class="['flex flex-col items-center p-2 w-full transition-colors', currentTab === 'talk' ? 'text-indigo-600' : 'text-gray-400']">
                <span class="text-2xl">ğŸ’¬</span>
                <span class="text-[10px] font-bold mt-1">æ—…éŠæœƒè©±</span>
            </button>
            <button @click="switchTab('kana')" :class="['flex flex-col items-center p-2 w-full transition-colors', currentTab === 'kana' ? 'text-indigo-600' : 'text-gray-400']">
                <span class="text-2xl">ã‚</span>
                <span class="text-[10px] font-bold mt-1">äº”åéŸ³è¡¨</span>
            </button>
            <button @click="switchTab('vocab')" :class="['flex flex-col items-center p-2 w-full transition-colors', currentTab === 'vocab' ? 'text-indigo-600' : 'text-gray-400']">
                <span class="text-2xl">ğŸ“š</span>
                <span class="text-[10px] font-bold mt-1">JLPTå–®å­—</span>
            </button>
        </nav>

    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    currentTab: 'talk',
                    loading: false,
                    error: null,
                    
                    // --- 1. æœƒè©±è³‡æ–™ ---
                    currConvCat: 'basic',
                    conversationCats: [
                        {id: 'basic', name: 'ğŸ‘‹ åŸºç¤'}, {id: 'food', name: 'ğŸœ é¤å»³'}, 
                        {id: 'shop', name: 'ğŸ›ï¸ è³¼ç‰©'}, {id: 'hotel', name: 'ğŸ¨ ä½å®¿'}, {id: 'traffic', name: 'ğŸš… äº¤é€š'}
                    ],
                    conversations: [
                        { cat: 'basic', jp: 'ã™ã¿ã¾ã›ã‚“', reading: 'Sumimasen', meaning: 'ä¸å¥½æ„æ€ / è«‹å•' },
                        { cat: 'basic', jp: 'ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™', reading: 'Arigatou gozaimasu', meaning: 'éå¸¸æ„Ÿè¬' },
                        { cat: 'food', jp: 'ã“ã‚Œã‚’ãŠé¡˜ã„ã—ã¾ã™', reading: 'Kore o onegaishimasu', meaning: 'æˆ‘è¦é»é€™å€‹(æŒ‡)' },
                        { cat: 'food', jp: 'ãŠä¼šè¨ˆã‚’ãŠé¡˜ã„ã—ã¾ã™', reading: 'Okaikei o onegaishimasu', meaning: 'éº»ç…©çµå¸³' },
                        { cat: 'shop', jp: 'ã“ã‚Œã„ãã‚‰ã§ã™ã‹ï¼Ÿ', reading: 'Kore ikura desu ka?', meaning: 'é€™å€‹å¤šå°‘éŒ¢ï¼Ÿ' },
                        { cat: 'hotel', jp: 'è·ç‰©ã‚’é ã‹ã£ã¦ã‚‚ã‚‰ãˆã¾ã™ã‹ï¼Ÿ', reading: 'Nimotsu o azukatte moraemasu ka?', meaning: 'å¯ä»¥å¯„æ”¾è¡Œæå—ï¼Ÿ' },
                        { cat: 'traffic', jp: 'åˆ‡ç¬¦å£²ã‚Šå ´ã¯ã©ã“ã§ã™ã‹ï¼Ÿ', reading: 'Kippu uriba wa doko desu ka?', meaning: 'å”®ç¥¨è™•åœ¨å“ªè£¡ï¼Ÿ' },
                    ],

                    // --- 2. äº”åéŸ³è³‡æ–™ ---
                    kanaMode: 'hira',
                    kanaTable: [
                        { h: 'ã‚', k: 'ã‚¢', r: 'a' }, { h: 'ã„', k: 'ã‚¤', r: 'i' }, { h: 'ã†', k: 'ã‚¦', r: 'u' }, { h: 'ãˆ', k: 'ã‚¨', r: 'e' }, { h: 'ãŠ', k: 'ã‚ª', r: 'o' },
                        { h: 'ã‹', k: 'ã‚«', r: 'ka' }, { h: 'ã', k: 'ã‚­', r: 'ki' }, { h: 'ã', k: 'ã‚¯', r: 'ku' }, { h: 'ã‘', k: 'ã‚±', r: 'ke' }, { h: 'ã“', k: 'ã‚³', r: 'ko' },
                        { h: 'ã•', k: 'ã‚µ', r: 'sa' }, { h: 'ã—', k: 'ã‚·', r: 'shi' }, { h: 'ã™', k: 'ã‚¹', r: 'su' }, { h: 'ã›', k: 'ã‚»', r: 'se' }, { h: 'ã', k: 'ã‚½', r: 'so' },
                        { h: 'ãŸ', k: 'ã‚¿', r: 'ta' }, { h: 'ã¡', k: 'ãƒ', r: 'chi' }, { h: 'ã¤', k: 'ãƒ„', r: 'tsu' }, { h: 'ã¦', k: 'ãƒ†', r: 'te' }, { h: 'ã¨', k: 'ãƒˆ', r: 'to' },
                        { h: 'ãª', k: 'ãƒŠ', r: 'na' }, { h: 'ã«', k: 'ãƒ‹', r: 'ni' }, { h: 'ã¬', k: 'ãƒŒ', r: 'nu' }, { h: 'ã­', k: 'ãƒ', r: 'ne' }, { h: 'ã®', k: 'ãƒ', r: 'no' },
                        { h: 'ã¯', k: 'ãƒ', r: 'ha' }, { h: 'ã²', k: 'ãƒ’', r: 'hi' }, { h: 'ãµ', k: 'ãƒ•', r: 'fu' }, { h: 'ã¸', k: 'ãƒ˜', r: 'he' }, { h: 'ã»', k: 'ãƒ›', r: 'ho' },
                        { h: 'ã¾', k: 'ãƒ', r: 'ma' }, { h: 'ã¿', k: 'ãƒŸ', r: 'mi' }, { h: 'ã‚€', k: 'ãƒ ', r: 'mu' }, { h: 'ã‚', k: 'ãƒ¡', r: 'me' }, { h: 'ã‚‚', k: 'ãƒ¢', r: 'mo' },
                        { h: 'ã‚„', k: 'ãƒ¤', r: 'ya' }, { h: '', k: '', r: '' }, { h: 'ã‚†', k: 'ãƒ¦', r: 'yu' }, { h: '', k: '', r: '' }, { h: 'ã‚ˆ', k: 'ãƒ¨', r: 'yo' },
                        { h: 'ã‚‰', k: 'ãƒ©', r: 'ra' }, { h: 'ã‚Š', k: 'ãƒª', r: 'ri' }, { h: 'ã‚‹', k: 'ãƒ«', r: 'ru' }, { h: 'ã‚Œ', k: 'ãƒ¬', r: 're' }, { h: 'ã‚', k: 'ãƒ­', r: 'ro' },
                        { h: 'ã‚', k: 'ãƒ¯', r: 'wa' }, { h: '', k: '', r: '' }, { h: 'ã‚’', k: 'ãƒ²', r: 'wo' }, { h: '', k: '', r: '' }, { h: 'ã‚“', k: 'ãƒ³', r: 'n' },
                    ],

                    // --- 3. JLPT è³‡æ–™ (ä½¿ç”¨ jamsinclair/open-anki-jlpt-decks CSV) ---
                    currentLevel: 'n5',
                    searchQuery: '',
                    vocabDatabase: {}, 
                    activeVocabList: [],
                    // ğŸŒŸ é€™äº›ç¶²å€æ˜¯ä¾†è‡ªä¸€å€‹éå¸¸ç©©å®šçš„å¤§å‹ GitHub å°ˆæ¡ˆ (400+ stars)
                    sources: {
                        n5: 'https://raw.githubusercontent.com/jamsinclair/open-anki-jlpt-decks/master/src/n5.csv',
                        n4: 'https://raw.githubusercontent.com/jamsinclair/open-anki-jlpt-decks/master/src/n4.csv',
                        n3: 'https://raw.githubusercontent.com/jamsinclair/open-anki-jlpt-decks/master/src/n3.csv',
                        n2: 'https://raw.githubusercontent.com/jamsinclair/open-anki-jlpt-decks/master/src/n2.csv',
                        n1: 'https://raw.githubusercontent.com/jamsinclair/open-anki-jlpt-decks/master/src/n1.csv'
                    }
                }
            },
            computed: {
                pageTitle() {
                    if(this.currentTab === 'talk') return 'æ—…éŠæœƒè©±';
                    if(this.currentTab === 'kana') return 'äº”åéŸ³è¡¨';
                    return 'JLPT å–®å­—åº«';
                },
                filteredConversations() {
                    return this.conversations.filter(c => c.cat === this.currConvCat);
                },
                currentKanaList() {
                    return this.kanaTable.map(item => ({
                        char: this.kanaMode === 'hira' ? item.h : item.k,
                        romaji: item.r
                    }));
                },
                filteredVocab() {
                    const q = this.searchQuery.toLowerCase().trim();
                    if (!q) return this.activeVocabList;
                    return this.activeVocabList.filter(w => 
                        (w.kanji && w.kanji.includes(q)) || 
                        (w.kana && w.kana.includes(q)) || 
                        (w.meaning && w.meaning.toLowerCase().includes(q))
                    );
                }
            },
            mounted() {
                this.loadVocabLevel('n5');
            },
            methods: {
                switchTab(tab) {
                    this.currentTab = tab;
                    if (this.$refs.mainScroll) this.$refs.mainScroll.scrollTop = 0;
                },
                speak(text) {
                    if (!text) return;
                    if ('speechSynthesis' in window) {
                        const u = new SpeechSynthesisUtterance(text);
                        u.lang = 'ja-JP';
                        u.rate = this.currentTab === 'kana' ? 0.7 : 0.9;
                        window.speechSynthesis.cancel();
                        window.speechSynthesis.speak(u);
                    }
                },
                loadVocabLevel(level) {
                    this.currentLevel = level;
                    this.searchQuery = ''; 
                    this.error = null;

                    if (this.vocabDatabase[level]) {
                        this.activeVocabList = this.vocabDatabase[level];
                        return;
                    }

                    this.loading = true;
                    this.activeVocabList = []; 

                    const url = this.sources[level];
                    
                    // ä½¿ç”¨ PapaParse è§£æ CSV
                    Papa.parse(url, {
                        download: true,
                        header: false, // è©²ä¾†æºæ²’æœ‰æ¨™é¡Œåˆ—
                        complete: (results) => {
                            // è³‡æ–™è½‰æ›ï¼šCSV çš„æ ¼å¼é€šå¸¸æ˜¯ [Kanji, Kana, Meaning]
                            // jamsinclair çš„æ ¼å¼æ¯”è¼ƒç‰¹åˆ¥ï¼Œæˆ‘å€‘å‹•æ…‹åˆ¤æ–·ä¸€ä¸‹
                            const rawData = results.data;
                            
                            const cleanData = rawData.map(row => {
                                // å¿½ç•¥ç©ºè¡Œ
                                if(row.length < 2) return null;
                                
                                // å˜—è©¦è§£æï¼šé€šå¸¸ row[0] æ˜¯æ¼¢å­—+å‡åï¼Œrow[1] æ˜¯å‡åï¼Œrow[2] æ˜¯æ„æ€
                                // ä½†æœ‰æ™‚å€™åªæœ‰ row[0] (æ¼¢å­—) å’Œ row[1] (æ„æ€)
                                let kanji = row[0] || '';
                                let kana = row[1] || '';
                                let meaning = row[2] || '';

                                // ç°¡å–®çš„æ¸…æ´—é‚è¼¯
                                if (!meaning && kana) { 
                                    meaning = kana; // å¦‚æœæ²’æœ‰ç¬¬ä¸‰æ¬„ï¼Œç¬¬äºŒæ¬„å¯èƒ½æ˜¯æ„æ€
                                    kana = '';      // é‚£å‡åå°±ç©ºè‘—ï¼ˆæˆ–è®“èªéŸ³ç›´æ¥å”¸æ¼¢å­—ï¼‰
                                }

                                return {
                                    kanji: kanji,
                                    kana: kana,
                                    meaning: meaning
                                };
                            }).filter(item => item !== null);

                            this.vocabDatabase[level] = cleanData;
                            this.activeVocabList = cleanData;
                            this.loading = false;
                        },
                        error: (err) => {
                            console.error(err);
                            this.error = `ç„¡æ³•ä¸‹è¼‰ ${level.toUpperCase()} å–®å­—åº«ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚`;
                            this.loading = false;
                        }
                    });
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
