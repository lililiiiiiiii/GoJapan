<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GoJapan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', 'Noto Sans JP', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .jp-font { font-family: 'Noto Sans JP', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .loader {
            border: 3px solid #e2e8f0;
            border-radius: 50%;
            border-top: 3px solid #f43f5e;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen flex flex-col overflow-hidden">

    <div id="app" class="max-w-md mx-auto w-full h-full bg-white shadow-2xl relative flex flex-col">
        
        <header class="bg-gradient-to-r from-rose-500 to-rose-600 text-white p-4 shadow-md z-20 flex-none flex justify-between items-center">
            <h1 class="text-xl font-bold flex items-center gap-2 tracking-wide">
                <span class="bg-white text-rose-600 rounded-full w-8 h-8 flex items-center justify-center text-sm shadow-sm">GO</span> 
                GoJapan
            </h1>
            <span class="text-[10px] font-bold bg-rose-700/50 px-3 py-1 rounded-full text-white tracking-wider backdrop-blur-sm border border-rose-400/30">
               {{ currentTab === 'vocab' ? currentLevel.toUpperCase() : (currentTab === 'talk' ? 'PHRASES' : 'KANA') }}
            </span>
        </header>

        <main class="flex-1 overflow-y-auto overflow-x-hidden bg-slate-50 relative scroll-smooth pb-24" 
              ref="mainScroll" 
              @scroll="handleScroll">
            
            <div v-show="currentTab === 'talk'" class="p-4 space-y-4">
                <div class="flex overflow-x-auto gap-2 pb-2 no-scrollbar">
                    <button v-for="cat in conversationCats" :key="cat.id" 
                        @click="currConvCat = cat.id"
                        :class="['px-4 py-2 rounded-full whitespace-nowrap text-sm font-bold transition-all border shadow-sm', 
                        currConvCat === cat.id ? 'bg-rose-500 text-white border-rose-500' : 'bg-white text-gray-500 border-gray-200 hover:bg-gray-50']">
                        {{ cat.name }}
                    </button>
                </div>

                <div v-for="(item, idx) in filteredConversations" :key="idx" @click="speak(item.jp)"
                    class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-rose-400 active:scale-[0.98] transition-all flex items-start gap-3 cursor-pointer group hover:shadow-md">
                    <div class="mt-1 text-rose-400 group-hover:text-rose-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    </div>
                    <div>
                        <div class="jp-font text-lg font-bold text-slate-800 leading-snug">{{ item.jp }}</div>
                        <div class="text-xs text-rose-500 font-mono mb-1">{{ item.reading }}</div>
                        <div class="text-sm text-slate-500 font-medium">{{ item.meaning }}</div>
                    </div>
                </div>
            </div>

            <div v-show="currentTab === 'kana'" class="p-4">
                <div class="flex bg-gray-200 rounded-lg p-1 mb-4">
                    <button @click="kanaMode = 'hira'" :class="['flex-1 py-2 text-sm font-bold rounded-md transition-all', kanaMode === 'hira' ? 'bg-white shadow text-rose-600' : 'text-gray-500']">å¹³å‡å (ã‚)</button>
                    <button @click="kanaMode = 'kata'" :class="['flex-1 py-2 text-sm font-bold rounded-md transition-all', kanaMode === 'kata' ? 'bg-white shadow text-rose-600' : 'text-gray-500']">ç‰‡å‡å (ã‚¢)</button>
                </div>

                <div class="grid grid-cols-5 gap-2 text-center">
                    <div v-for="(k, idx) in currentKanaList" :key="idx" 
                        @click="speak(k.char)"
                        :class="['aspect-square rounded-xl flex flex-col justify-center items-center shadow-sm border cursor-pointer active:scale-90 transition-transform select-none',
                        k.char ? 'bg-white border-slate-200 hover:border-rose-400 hover:bg-rose-50' : 'bg-transparent border-none shadow-none']">
                        <span class="jp-font text-xl font-bold text-slate-700">{{ k.char }}</span>
                        <span class="text-[10px] text-gray-400 font-mono uppercase mt-1">{{ k.romaji }}</span>
                    </div>
                </div>
            </div>

            <div v-show="currentTab === 'vocab'" class="flex flex-col min-h-full">
                <div class="p-4 bg-white border-b sticky top-0 z-10 shadow-sm">
                    <div class="flex justify-between gap-1 mb-3">
                        <button v-for="n in ['n5', 'n4', 'n3', 'n2', 'n1']" :key="n"
                            @click="loadVocabLevel(n)"
                            :class="['flex-1 py-2 text-xs font-bold rounded-lg uppercase tracking-wider border transition-all',
                            currentLevel === n ? 'bg-rose-600 text-white border-rose-600 shadow-md' : 'bg-white text-gray-500 border-gray-200']">
                            {{ n }}
                        </button>
                    </div>
                    <div class="relative">
                        <span class="absolute left-3 top-2.5 text-gray-400">ğŸ”</span>
                        <input v-model="searchQuery" placeholder="æœå°‹æ¼¢å­—ã€å‡åæˆ–æ„æ€..." 
                            class="w-full bg-slate-100 border-none rounded-lg pl-9 pr-4 py-2 text-sm focus:ring-2 focus:ring-rose-500 outline-none transition-shadow">
                        <button v-if="searchQuery" @click="searchQuery = ''" class="absolute right-3 top-2.5 text-gray-400 text-xs bg-slate-200 rounded-full px-1.5">âœ•</button>
                    </div>
                </div>

                <div class="p-4 space-y-3 flex-1">
                    <div v-if="loading" class="flex flex-col items-center justify-center py-20 text-gray-400">
                        <div class="loader mb-3"></div>
                        <p class="text-sm">ä¸‹è¼‰ä¸­...</p>
                    </div>
                    
                    <div v-else-if="error" class="text-center py-10 text-rose-400 text-sm px-4">
                        <p>{{ error }}</p>
                        <button @click="loadVocabLevel(currentLevel)" class="mt-4 px-4 py-2 bg-rose-50 text-rose-600 rounded-full text-xs font-bold">é‡è©¦</button>
                    </div>

                    <div v-else>
                        <div class="text-right text-xs text-gray-400 mb-2 flex justify-between px-1">
                             <span>å·²é¡¯ç¤º {{ displayedVocab.length }} ç­†</span>
                             <span>å…± {{ filteredVocab.length }} ç­†</span>
                        </div>
                        
                        <div v-for="(word, idx) in displayedVocab" :key="idx" @click="speak(word.kana || word.kanji)"
                            class="bg-white border-l-4 border-emerald-500 p-3 pl-4 rounded-r-lg shadow-sm mb-3 flex justify-between items-start cursor-pointer active:bg-gray-50 hover:shadow-md transition-all">
                            <div class="flex-1">
                                <div class="flex flex-col">
                                    <span class="jp-font text-lg font-bold text-gray-800">{{ word.kanji || word.kana }}</span>
                                    <span v-if="word.kanji" class="text-xs text-rose-600 font-mono">{{ word.kana }}</span>
                                </div>
                                <div class="text-sm text-gray-600 mt-1 leading-snug break-words pr-2">{{ word.meaning }}</div>
                            </div>
                            <span class="text-gray-300 ml-2 mt-1 shrink-0">ğŸ”Š</span>
                        </div>
                        
                        <div class="text-center py-6">
                            <div v-if="displayedVocab.length < filteredVocab.length" class="text-gray-400 text-xs">
                                <div class="loader mx-auto w-5 h-5 border-2 mb-2"></div>
                                æ»‘å‹•è¼‰å…¥æ›´å¤š...
                            </div>
                            <div v-else-if="filteredVocab.length > 0" class="text-gray-300 text-xs">
                                - å·²ç¶“åˆ°åº•å›‰ -
                            </div>
                            <div v-else class="text-gray-400 text-sm">
                                æ‰¾ä¸åˆ°ç¬¦åˆçš„å–®å­—
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <nav class="bg-white border-t border-gray-200 flex justify-around items-center p-2 pb-safe z-30 flex-none safe-bottom shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
            <button @click="switchTab('talk')" :class="['flex flex-col items-center p-2 w-full transition-colors', currentTab === 'talk' ? 'text-rose-600' : 'text-gray-400']">
                <span class="text-2xl">ğŸ’¬</span>
                <span class="text-[10px] font-bold mt-1">æœƒè©±</span>
            </button>
            <button @click="switchTab('kana')" :class="['flex flex-col items-center p-2 w-full transition-colors', currentTab === 'kana' ? 'text-rose-600' : 'text-gray-400']">
                <span class="text-2xl">ã‚</span>
                <span class="text-[10px] font-bold mt-1">äº”åéŸ³</span>
            </button>
            <button @click="switchTab('vocab')" :class="['flex flex-col items-center p-2 w-full transition-colors', currentTab === 'vocab' ? 'text-rose-600' : 'text-gray-400']">
                <span class="text-2xl">ğŸ“š</span>
                <span class="text-[10px] font-bold mt-1">JLPT</span>
            </button>
        </nav>

    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    currentTab: 'talk',
                    loading: false,
                    error: null,
                    
                    // --- JLPT ç›¸é—œè®Šæ•¸ ---
                    currentLevel: 'n5',
                    searchQuery: '',
                    vocabDatabase: {}, 
                    activeVocabList: [], // è©²ç­‰ç´šæ‰€æœ‰å–®å­—
                    pageLimit: 50,       // ç•¶å‰é¡¯ç¤ºæ•¸é‡ (ç„¡é™æ²å‹•ç”¨)
                    
                    // --- 1. GoJapan æœƒè©±è³‡æ–™ ---
                    currConvCat: 'basic',
                    conversationCats: [
                        {id: 'basic', name: 'ğŸ‘‹ åŸºç¤'}, 
                        {id: 'airport', name: 'âœˆï¸ æ©Ÿå ´'},
                        {id: 'transport', name: 'ğŸš… äº¤é€š'}, 
                        {id: 'food', name: 'ğŸœ ç¾é£Ÿ'}, 
                        {id: 'shop', name: 'ğŸ›ï¸ è³¼ç‰©'}, 
                        {id: 'hotel', name: 'ğŸ¨ ä½å®¿'},
                        {id: 'emergency', name: 'ğŸš‘ ç·Šæ€¥'}
                    ],
                    conversations: [
                         { cat: 'basic', jp: 'ã™ã¿ã¾ã›ã‚“', reading: 'Sumimasen', meaning: 'ä¸å¥½æ„æ€ / è«‹å•' },
                        { cat: 'basic', jp: 'ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™', reading: 'Arigatou gozaimasu', meaning: 'éå¸¸æ„Ÿè¬' },
                        { cat: 'basic', jp: 'ã¯ã„ / ã„ã„ãˆ', reading: 'Hai / Iie', meaning: 'æ˜¯ / ä¸æ˜¯' },
                        { cat: 'basic', jp: 'å¤§ä¸ˆå¤«ã§ã™', reading: 'Daijoubu desu', meaning: 'æ²’é—œä¿‚ / ä¸éœ€è¦' },
                        { cat: 'basic', jp: 'æ—¥æœ¬èªãŒã‚ã‹ã‚Šã¾ã›ã‚“', reading: 'Nihongo ga wakarimasen', meaning: 'æˆ‘ä¸æ‡‚æ—¥æ–‡' },
                        { cat: 'basic', jp: 'è‹±èªã¯è©±ã›ã¾ã™ã‹ï¼Ÿ', reading: 'Eigo wa hanasemasu ka?', meaning: 'ä½ æœƒèªªè‹±æ–‡å—ï¼Ÿ' },
                        { cat: 'basic', jp: 'ã‚†ã£ãã‚Šè©±ã—ã¦ãã ã•ã„', reading: 'Yukkuri hanashite kudasai', meaning: 'è«‹èªªæ…¢ä¸€é»' },
                        { cat: 'basic', jp: 'ãƒˆã‚¤ãƒ¬ã¯ã©ã“ã§ã™ã‹ï¼Ÿ', reading: 'Toire wa doko desu ka?', meaning: 'å»æ‰€åœ¨å“ªè£¡ï¼Ÿ' },
                        { cat: 'airport', jp: 'ãƒ‘ã‚¹ãƒãƒ¼ãƒˆã‚’è¦‹ã›ã¦ãã ã•ã„', reading: 'Pasupo-to o misete kudasai', meaning: '(æµ·é—œ) è«‹å‡ºç¤ºè­·ç…§' },
                        { cat: 'airport', jp: 'è¦³å…‰ã§ã™', reading: 'Kankou desu', meaning: 'æˆ‘æ˜¯ä¾†è§€å…‰çš„' },
                        { cat: 'airport', jp: 'è·ç‰©ã¯ã©ã“ã§ã™ã‹ï¼Ÿ', reading: 'Nimotsu wa doko desu ka?', meaning: 'è¡Œæåœ¨å“ªè£¡æ‹¿ï¼Ÿ' },
                        { cat: 'airport', jp: 'ãƒã‚¹ä¹—ã‚Šå ´ã¯ã©ã“ã§ã™ã‹ï¼Ÿ', reading: 'Basu noriba wa doko desu ka?', meaning: 'å·´å£«ç«™åœ¨å“ªè£¡ï¼Ÿ' },
                        { cat: 'transport', jp: 'åˆ‡ç¬¦å£²ã‚Šå ´ã¯ã©ã“ã§ã™ã‹ï¼Ÿ', reading: 'Kippu uriba wa doko desu ka?', meaning: 'å”®ç¥¨è™•åœ¨å“ªè£¡ï¼Ÿ' },
                        { cat: 'transport', jp: 'æ–°å®¿é§…ã«è¡ŒããŸã„ã§ã™', reading: 'Shinjuku-eki ni ikitai desu', meaning: 'æˆ‘æƒ³å»æ–°å®¿ç«™' },
                        { cat: 'transport', jp: 'ã“ã®é›»è»Šã¯æ–°å®¿ã«è¡Œãã¾ã™ã‹ï¼Ÿ', reading: 'Kono densha wa Shinjuku ni ikimasu ka?', meaning: 'é€™ç­è»Šå»æ–°å®¿å—ï¼Ÿ' },
                        { cat: 'transport', jp: 'è·¯ç·šå›³ï¼ˆã‚ã›ã‚“ãšï¼‰', reading: 'Rosenzu', meaning: 'è·¯ç·šåœ–' },
                        { cat: 'transport', jp: 'ICã‚«ãƒ¼ãƒ‰ã®ãƒãƒ£ãƒ¼ã‚¸', reading: 'IC ka-do no cha-ji', meaning: 'å„²å€¼ IC å¡' },
                        { cat: 'transport', jp: 'ã“ã“ã§é™ã‚Šã¾ã™', reading: 'Koko de orimasu', meaning: 'æˆ‘åœ¨é€™ä¸‹è»Š' },
                        { cat: 'food', jp: 'ä¸€åã§ã™ / äºŒåã§ã™', reading: 'Hitoridesu / Futari desu', meaning: 'ä¸€ä½ / å…©ä½' },
                        { cat: 'food', jp: 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ãã ã•ã„', reading: 'Menyu o kudasai', meaning: 'è«‹çµ¦æˆ‘èœå–®' },
                        { cat: 'food', jp: 'è‹±èªãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ', reading: 'Eigo menyu wa arimasu ka?', meaning: 'æœ‰è‹±æ–‡èœå–®å—ï¼Ÿ' },
                        { cat: 'food', jp: 'ãŠã™ã™ã‚ã¯ã©ã‚Œã§ã™ã‹ï¼Ÿ', reading: 'Osusume wa dore desu ka?', meaning: 'æ¨è–¦å“ªä¸€å€‹ï¼Ÿ' },
                        { cat: 'food', jp: 'ã“ã‚Œã‚’ãŠé¡˜ã„ã—ã¾ã™', reading: 'Kore o onegaishimasu', meaning: 'æˆ‘è¦é»é€™å€‹(æŒ‡)' },
                        { cat: 'food', jp: 'ãŠæ°´ã‚’ãã ã•ã„', reading: 'Omizu o kudasai', meaning: 'è«‹çµ¦æˆ‘æ°´' },
                        { cat: 'food', jp: 'ãŠä¼šè¨ˆã‚’ãŠé¡˜ã„ã—ã¾ã™', reading: 'Okaikei o onegaishimasu', meaning: 'éº»ç…©çµå¸³' },
                        { cat: 'food', jp: 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ã¯ä½¿ãˆã¾ã™ã‹ï¼Ÿ', reading: 'Kurejitto ka-do wa tsukaemasu ka?', meaning: 'å¯ä»¥åˆ·å¡å—ï¼Ÿ' },
                        { cat: 'food', jp: 'ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆã§ãã¾ã™ã‹ï¼Ÿ', reading: 'Teiku-auto dekimasu ka?', meaning: 'å¯ä»¥å¤–å¸¶å—ï¼Ÿ' },
                        { cat: 'shop', jp: 'ã“ã‚Œã„ãã‚‰ã§ã™ã‹ï¼Ÿ', reading: 'Kore ikura desu ka?', meaning: 'é€™å€‹å¤šå°‘éŒ¢ï¼Ÿ' },
                        { cat: 'shop', jp: 'è©¦ç€ã—ã¦ã‚‚ã„ã„ã§ã™ã‹ï¼Ÿ', reading: 'Shichaku shitemo ii desu ka?', meaning: 'å¯ä»¥è©¦ç©¿å—ï¼Ÿ' },
                        { cat: 'shop', jp: 'å¤§ãã™ãã¾ã™ / å°ã•ã™ãã¾ã™', reading: 'Ookisugimasu / Chiisasugimasu', meaning: 'å¤ªå¤§ / å¤ªå°' },
                        { cat: 'shop', jp: 'æ–°ã—ã„ã®ã‚ã‚Šã¾ã™ã‹ï¼Ÿ', reading: 'Atarashii no arimasu ka?', meaning: 'æœ‰æ–°çš„(åº«å­˜)å—ï¼Ÿ' },
                        { cat: 'shop', jp: 'å…ç¨ï¼ˆã‚ã‚“ãœã„ï¼‰ã§ãã¾ã™ã‹ï¼Ÿ', reading: 'Menzei dekimasu ka?', meaning: 'å¯ä»¥é€€ç¨…å—ï¼Ÿ' },
                        { cat: 'shop', jp: 'è¢‹ï¼ˆãµãã‚ï¼‰ã„ã‚Šã¾ã›ã‚“', reading: 'Fukuro irimasen', meaning: 'ä¸ç”¨è¢‹å­' },
                        { cat: 'hotel', jp: 'ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã‚’ãŠé¡˜ã„ã—ã¾ã™', reading: 'Chekku-in o onegaishimasu', meaning: 'æˆ‘è¦è¾¦ç†å…¥ä½' },
                        { cat: 'hotel', jp: 'äºˆç´„ã—ã¦ã„ã¾ã™', reading: 'Yoyaku shiteimasu', meaning: 'æˆ‘æœ‰é ç´„' },
                        { cat: 'hotel', jp: 'è·ç‰©ã‚’é ã‹ã£ã¦ã‚‚ã‚‰ãˆã¾ã™ã‹ï¼Ÿ', reading: 'Nimotsu o azukatte moraemasu ka?', meaning: 'å¯ä»¥å¯„æ”¾è¡Œæå—ï¼Ÿ' },
                        { cat: 'hotel', jp: 'Wi-Fiã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ï¼Ÿ', reading: 'Wi-Fi no pasuwa-do wa?', meaning: 'Wi-Fi å¯†ç¢¼æ˜¯å¤šå°‘ï¼Ÿ' },
                        { cat: 'hotel', jp: 'æœé£Ÿã¯ä½•æ™‚ã§ã™ã‹ï¼Ÿ', reading: 'Choushoku wa nanji desu ka?', meaning: 'æ—©é¤å¹¾é»é–‹å§‹ï¼Ÿ' },
                        { cat: 'emergency', jp: 'åŠ©ã‘ã¦ãã ã•ã„ï¼', reading: 'Tasukete kudasai!', meaning: 'æ•‘å‘½ / å¹«å¹«æˆ‘ï¼' },
                        { cat: 'emergency', jp: 'è­¦å¯Ÿã‚’å‘¼ã‚“ã§ãã ã•ã„', reading: 'Keisatsu o yonde kudasai', meaning: 'è«‹å«è­¦å¯Ÿ' },
                        { cat: 'emergency', jp: 'æ•‘æ€¥è»Šï¼ˆãã‚…ã†ãã‚…ã†ã—ã‚ƒï¼‰', reading: 'Kyuukyuusha', meaning: 'æ•‘è­·è»Š' },
                        { cat: 'emergency', jp: 'è²¡å¸ƒã‚’ãªãã—ã¾ã—ãŸ', reading: 'Saifu o nakushimashita', meaning: 'éŒ¢åŒ…å¼„ä¸Ÿäº†' },
                        { cat: 'emergency', jp: 'æ°—åˆ†ãŒæ‚ªã„ã§ã™', reading: 'Kibun ga warui desu', meaning: 'æˆ‘ä¸èˆ’æœ' }
                    ],

                    // --- 2. äº”åéŸ³è³‡æ–™ ---
                    kanaMode: 'hira',
                    kanaTable: [
                        { h: 'ã‚', k: 'ã‚¢', r: 'a' }, { h: 'ã„', k: 'ã‚¤', r: 'i' }, { h: 'ã†', k: 'ã‚¦', r: 'u' }, { h: 'ãˆ', k: 'ã‚¨', r: 'e' }, { h: 'ãŠ', k: 'ã‚ª', r: 'o' },
                        { h: 'ã‹', k: 'ã‚«', r: 'ka' }, { h: 'ã', k: 'ã‚­', r: 'ki' }, { h: 'ã', k: 'ã‚¯', r: 'ku' }, { h: 'ã‘', k: 'ã‚±', r: 'ke' }, { h: 'ã“', k: 'ã‚³', r: 'ko' },
                        { h: 'ã•', k: 'ã‚µ', r: 'sa' }, { h: 'ã—', k: 'ã‚·', r: 'shi' }, { h: 'ã™', k: 'ã‚¹', r: 'su' }, { h: 'ã›', k: 'ã‚»', r: 'se' }, { h: 'ã', k: 'ã‚½', r: 'so' },
                        { h: 'ãŸ', k: 'ã‚¿', r: 'ta' }, { h: 'ã¡', k: 'ãƒ', r: 'chi' }, { h: 'ã¤', k: 'ãƒ„', r: 'tsu' }, { h: 'ã¦', k: 'ãƒ†', r: 'te' }, { h: 'ã¨', k: 'ãƒˆ', r: 'to' },
                        { h: 'ãª', k: 'ãƒŠ', r: 'na' }, { h: 'ã«', k: 'ãƒ‹', r: 'ni' }, { h: 'ã¬', k: 'ãƒŒ', r: 'nu' }, { h: 'ã­', k: 'ãƒ', r: 'ne' }, { h: 'ã®', k: 'ãƒ', r: 'no' },
                        { h: 'ã¯', k: 'ãƒ', r: 'ha' }, { h: 'ã²', k: 'ãƒ’', r: 'hi' }, { h: 'ãµ', k: 'ãƒ•', r: 'fu' }, { h: 'ã¸', k: 'ãƒ˜', r: 'he' }, { h: 'ã»', k: 'ãƒ›', r: 'ho' },
                        { h: 'ã¾', k: 'ãƒ', r: 'ma' }, { h: 'ã¿', k: 'ãƒŸ', r: 'mi' }, { h: 'ã‚€', k: 'ãƒ ', r: 'mu' }, { h: 'ã‚', k: 'ãƒ¡', r: 'me' }, { h: 'ã‚‚', k: 'ãƒ¢', r: 'mo' },
                        { h: 'ã‚„', k: 'ãƒ¤', r: 'ya' }, { h: '', k: '', r: '' }, { h: 'ã‚†', k: 'ãƒ¦', r: 'yu' }, { h: '', k: '', r: '' }, { h: 'ã‚ˆ', k: 'ãƒ¨', r: 'yo' },
                        { h: 'ã‚‰', k: 'ãƒ©', r: 'ra' }, { h: 'ã‚Š', k: 'ãƒª', r: 'ri' }, { h: 'ã‚‹', k: 'ãƒ«', r: 'ru' }, { h: 'ã‚Œ', k: 'ãƒ¬', r: 're' }, { h: 'ã‚', k: 'ãƒ­', r: 'ro' },
                        { h: 'ã‚', k: 'ãƒ¯', r: 'wa' }, { h: '', k: '', r: '' }, { h: 'ã‚’', k: 'ãƒ²', r: 'wo' }, { h: '', k: '', r: '' }, { h: 'ã‚“', k: 'ãƒ³', r: 'n' },
                    ],

                    // --- 3. JLPT è³‡æ–™ (CSV) ---
                    sources: {
                        n5: 'https://raw.githubusercontent.com/jamsinclair/open-anki-jlpt-decks/master/src/n5.csv',
                        n4: 'https://raw.githubusercontent.com/jamsinclair/open-anki-jlpt-decks/master/src/n4.csv',
                        n3: 'https://raw.githubusercontent.com/jamsinclair/open-anki-jlpt-decks/master/src/n3.csv',
                        n2: 'https://raw.githubusercontent.com/jamsinclair/open-anki-jlpt-decks/master/src/n2.csv',
                        n1: 'https://raw.githubusercontent.com/jamsinclair/open-anki-jlpt-decks/master/src/n1.csv'
                    }
                }
            },
            computed: {
                filteredConversations() {
                    return this.conversations.filter(c => c.cat === this.currConvCat);
                },
                currentKanaList() {
                    return this.kanaTable.map(item => ({
                        char: this.kanaMode === 'hira' ? item.h : item.k,
                        romaji: item.r
                    }));
                },
                // 1. å…ˆæ ¹æ“šæœå°‹å­—ä¸²éæ¿¾å…¨éƒ¨è³‡æ–™
                filteredVocab() {
                    const q = this.searchQuery.toLowerCase().trim();
                    if (!q) return this.activeVocabList;
                    return this.activeVocabList.filter(w => 
                        (w.kanji && w.kanji.includes(q)) || 
                        (w.kana && w.kana.includes(q)) || 
                        (w.meaning && w.meaning.toLowerCase().includes(q))
                    );
                },
                // 2. å†æ ¹æ“š pageLimit åˆ‡å‰²å‡ºè¦é¡¯ç¤ºçš„éƒ¨åˆ†
                displayedVocab() {
                    return this.filteredVocab.slice(0, this.pageLimit);
                }
            },
            watch: {
                // ç•¶æœå°‹é—œéµå­—æ”¹è®Šæ™‚ï¼Œé‡ç½®é¡¯ç¤ºæ•¸é‡ï¼Œé¿å…å·è»¸ä½ç½®æ€ªæ€ªçš„
                searchQuery() {
                    this.pageLimit = 50;
                    if (this.$refs.mainScroll) this.$refs.mainScroll.scrollTop = 0;
                }
            },
            mounted() {
                this.loadVocabLevel('n5');
            },
            methods: {
                switchTab(tab) {
                    this.currentTab = tab;
                    if (this.$refs.mainScroll) this.$refs.mainScroll.scrollTop = 0;
                },
                speak(text) {
                    if (!text) return;
                    if ('speechSynthesis' in window) {
                        const u = new SpeechSynthesisUtterance(text);
                        u.lang = 'ja-JP';
                        u.rate = this.currentTab === 'kana' ? 0.7 : 0.9;
                        window.speechSynthesis.cancel();
                        window.speechSynthesis.speak(u);
                    }
                },
                loadVocabLevel(level) {
                    this.currentLevel = level;
                    this.searchQuery = ''; 
                    this.error = null;
                    this.pageLimit = 50; // åˆ‡æ›ç­‰ç´šæ™‚é‡ç½®

                    if (this.vocabDatabase[level]) {
                        this.activeVocabList = this.vocabDatabase[level];
                        if (this.$refs.mainScroll) this.$refs.mainScroll.scrollTop = 0;
                        return;
                    }

                    this.loading = true;
                    this.activeVocabList = []; 

                    const url = this.sources[level];
                    
                    Papa.parse(url, {
                        download: true,
                        header: true,
                        skipEmptyLines: true,
                        complete: (results) => {
                            const rawData = results.data;
                            const cleanData = rawData.map(row => ({
                                kanji: row.expression || '',
                                kana: row.reading || '',
                                meaning: row.meaning || ''
                            })).filter(item => item.kanji && item.kanji !== 'expression');

                            this.vocabDatabase[level] = cleanData;
                            this.activeVocabList = cleanData;
                            this.loading = false;
                            if (this.$refs.mainScroll) this.$refs.mainScroll.scrollTop = 0;
                        },
                        error: (err) => {
                            console.error(err);
                            this.error = `ä¸‹è¼‰å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚`;
                            this.loading = false;
                        }
                    });
                },
                // ğŸš€ ç„¡é™æ²å‹•æ ¸å¿ƒé‚è¼¯
                handleScroll(e) {
                    // å¦‚æœä¸æ˜¯åœ¨å–®å­—åˆ†é ï¼Œå°±ä¸è™•ç†
                    if (this.currentTab !== 'vocab') return;
                    
                    const { scrollTop, clientHeight, scrollHeight } = e.target;
                    // ç•¶æ²å‹•åˆ°è·é›¢åº•éƒ¨ 100px å…§æ™‚ï¼Œä¸”é‚„æœ‰æ›´å¤šè³‡æ–™æ²’é¡¯ç¤º
                    if (scrollTop + clientHeight >= scrollHeight - 100) {
                        if (this.displayedVocab.length < this.filteredVocab.length) {
                            this.pageLimit += 50; // æ¯æ¬¡å¤šè¼‰å…¥ 50 ç­†
                        }
                    }
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
